services:
  reverse-proxy:
    image: traefik:v3.2
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    networks:
      - proxy
    environment:
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/docker-configs/traefik/traefik.yaml:/etc/traefik/traefik.yaml:ro
      - /etc/docker-configs/traefik/acme.json:/acme.json

  whoami:
    image: traefik/whoami
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`whoami.local.varshavskyi.com`)"
      - "traefik.http.routers.whoami.entrypoints=http"
      - "traefik.http.middlewares.whoami-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.whoami.middlewares=whoami-https-redirect"
      - "traefik.http.routers.whoami-secure.entrypoints=https"
      - "traefik.http.routers.whoami-secure.rule=Host(`whoami.local.varshavskyi.com`)"
      - "traefik.http.routers.whoami-secure.tls=true"
      - "traefik.http.routers.whoami-secure.tls.certresolver=cloudflare"
      - "traefik.http.routers.whoami-secure.tls.domains[0].main=local.varshavskyi.com"
      - "traefik.http.routers.whoami-secure.tls.domains[0].sans=*.local.varshavskyi.com"

networks:
  proxy:
      external: true
